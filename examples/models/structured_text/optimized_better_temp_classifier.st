FUNCTION_BLOCK NeuralNetworkFB

VAR_INPUT
    input_data : ARRAY[0..4] OF REAL;
END_VAR

VAR_OUTPUT
    output_data : ARRAY[0..2] OF REAL;
END_VAR

VAR CONSTANT
    weights_1 : ARRAY[0..79] OF REAL := [-0.095930, 0.000692, -0.604264, 0.007830, 0.027697, -0.110796, -0.121137, 0.119850, 0.057352, 0.002557, -0.385245, -0.190493, 0.015531, -0.107952, -0.004428, -0.455217, -0.228439, 0.000487, 0.502708, -0.011215, -0.003850, 0.117060, 0.120599, -0.019681, -0.033640, -0.174245, 0.352214, 0.226439, -0.073395, 0.115894, 0.001815, 0.047289, 0.130232, 0.009477, -0.059794, -0.001728, -0.190443, 0.033723, -0.017326, -0.050876, -0.119164, -0.004911, 0.035715, -0.020005, 0.085858, -0.066041, -0.001310, -0.063746, -0.051169, 0.001477, 0.372914, 0.067524, 0.337182, 0.028778, 0.043451, -0.477387, 0.013193, -0.300537, 0.073491, 0.131580, -0.126345, 0.092612, 0.000971, 0.090229, -0.105823, 0.247740, -0.379393, 0.370569, -0.515837, -0.246769, 0.246283, -0.544111, -0.117840, -0.010282, -0.288469, -0.503179, -0.058943, -0.247450, -0.083657, -0.015038];
    bias_1 : ARRAY[0..15] OF REAL := [-0.980481, -2.405819, 0.690016, -2.993280, 0.040576, 1.595755, -2.240234, 1.722846, 0.410530, -0.547844, 2.407200, 0.369404, 2.175193, 2.996372, 2.551130, -0.598656];

    weights_2 : ARRAY[0..191] OF REAL := [-0.261270, 0.107119, -0.057380, 0.239176, -0.531469, 0.012263, 0.035657, -0.096014, 0.004310, 0.120793, -0.087786, 0.030782, -0.055516, 0.199512, -0.682147, -0.007604, -0.110083, -0.045768, -0.092431, -1.149229, 0.249240, 0.167818, -1.157714, 0.341394, 0.135732, -0.008291, 0.049353, -0.514215, -0.152022, -0.251635, -0.153912, 0.006585, 0.149169, -0.086582, -0.029337, 0.035312, -0.020302, -0.011110, -0.289731, -0.008050, 0.191495, -0.007147, 0.219508, -0.448034, 0.133700, -0.208194, -0.342866, 0.048072, -0.335608, -0.274515, -0.048835, -0.236680, -0.090380, 0.036612, -0.205669, 0.064767, -0.502523, -0.562775, 0.037710, -0.180757, -0.442252, -0.208702, 0.103663, -0.104223, -0.398669, 0.493328, -0.170170, 0.077624, -0.503384, -0.263422, 0.144634, -0.085226, 0.094759, 0.184407, -0.651972, -0.008861, -0.043380, 0.275419, -0.045682, -0.842328, -0.076355, 0.106007, -0.005826, -0.201158, -0.556553, -0.327094, 0.002942, -0.452641, -0.159332, 0.310186, -0.189237, 0.007894, -0.294373, -0.186090, 0.014068, -0.326161, -0.345027, 0.073290, 0.050642, -0.107399, -0.324269, 0.381255, -0.053493, -0.067163, -0.129507, -0.023505, 0.082253, -0.175474, 0.188168, 0.063347, 0.019446, -0.180079, -0.276512, 0.228827, -0.089237, -0.002963, -0.043670, -0.109243, -0.101433, -0.100929, -0.011021, 0.048698, 0.110389, -1.080399, -0.104138, -0.112609, -0.363702, 0.054155, -0.059634, -0.578229, 0.102744, -0.036446, -0.331553, -0.071238, -0.032371, -0.388269, -0.216394, 0.064683, -0.123483, 0.063245, -0.495136, -0.160000, 0.251014, -0.257789, -0.521276, -0.339843, 0.102932, -0.848057, -0.042467, 0.023446, -0.108048, 0.087676, 0.072063, -0.154295, 0.227691, -0.163715, -0.975383, -0.318735, 0.041320, -1.233760, -0.324155, 0.115972, -0.496875, 0.013090, -0.216962, -0.313846, 0.286013, -0.487865, -1.711578, -1.448045, 0.074641, -0.485800, -0.881306, -0.269586, -0.601741, -0.125377, -1.803676, -1.520676, 0.261292, -1.616396, 0.171718, 0.335709, -0.022494, 0.007286, 0.136407, 0.098455, 0.311768, 0.027948, 0.296725, -0.252980, -0.009506, 0.367563];
    bias_2 : ARRAY[0..11] OF REAL := [1.481165, -0.758992, 1.639378, 1.376125, -0.883914, -1.043172, -1.322489, 1.710258, -0.570090, -0.204427, 1.442890, -0.280403];

    weights_3 : ARRAY[0..35] OF REAL := [-0.542195, -0.230593, 0.187449, 0.082667, -0.085455, 0.225467, 0.634390, -0.168816, 0.196424, -1.856785, 0.146151, 0.590299, -0.091240, -0.414188, 0.139226, -0.118131, -0.651260, -0.143628, 0.271132, -0.104659, 0.444165, 0.151004, -0.906230, -0.211486, -0.399137, -0.514309, -0.257237, 0.047009, -0.300323, 0.339689, 0.031179, -0.438313, -0.167528, 0.223605, 0.039704, 0.393325];
    bias_3 : ARRAY[0..2] OF REAL := [-0.692060, 1.614790, -1.157133];

END_VAR

VAR
    (* Layer 1 output variable *)
    layer_1_output : ARRAY[0..15] OF REAL;

    (* Layer 2 output variable *)
    layer_2_output : ARRAY[0..11] OF REAL;

    (* Layer 3 output variable *)
    layer_3_output : ARRAY[0..2] OF REAL;

    (* Temporary computation variables *)
    i : DINT;
    j : DINT;
    sum : REAL;
    max_val : REAL;
    exp_sum : REAL;

END_VAR

(* Layer 1: FusedGemm (RELU) *)
FOR j := 0 TO 15 DO
    sum := 0.0;
    FOR i := 0 TO 4 DO
        sum := sum + input_data[i] * weights_1[i * 16 + j];
    END_FOR;
    layer_1_output[j] := sum + bias_1[j];
END_FOR;

FOR i := 0 TO 15 DO
    layer_1_output[i] := MAX(layer_1_output[i], 0.0);
END_FOR;

(* Layer 2: FusedGemm (RELU) *)
FOR j := 0 TO 11 DO
    sum := 0.0;
    FOR i := 0 TO 15 DO
        sum := sum + layer_1_output[i] * weights_2[i * 12 + j];
    END_FOR;
    layer_2_output[j] := sum + bias_2[j];
END_FOR;

FOR i := 0 TO 11 DO
    layer_2_output[i] := MAX(layer_2_output[i], 0.0);
END_FOR;

(* Layer 3: Gemm *)
FOR j := 0 TO 2 DO
    sum := 0.0;
    FOR i := 0 TO 11 DO
        sum := sum + layer_2_output[i] * weights_3[i * 3 + j];
    END_FOR;
    layer_3_output[j] := sum + bias_3[j];
END_FOR;

(* Layer 4: Activation (SOFTMAX) *)
max_val := layer_3_output[0];
FOR i := 1 TO 2 DO
    IF layer_3_output[i] > max_val THEN
        max_val := layer_3_output[i];
    END_IF;
END_FOR;

exp_sum := 0.0;
FOR i := 0 TO 2 DO
    output_data[i] := EXP(layer_3_output[i] - max_val);
    exp_sum := exp_sum + output_data[i];
END_FOR;

FOR i := 0 TO 2 DO
    output_data[i] := output_data[i] / exp_sum;
END_FOR;

END_FUNCTION_BLOCK
